<%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ page language="java" pageEncoding="UTF-8"%>
<%@page import="org.dom4j.*"%>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title></title>
<script type="text/javascript" src="<c:url value='/js/jquery-1.8.2.js'/>"></script>
<script type="text/javascript" src="<c:url value='/js/ajaxfileupload.js'/>"></script>
<link rel="stylesheet" href="<c:url value='/css/ui.tabs.css'/>" type="text/css">

<script type="text/javascript" src="<c:url value='/js/ui.tabs.js'/>"></script>
<script type="text/javascript" src="<c:url value='/js/page_list.js'/>"></script>

<script type="text/javascript" src="<c:url value='/js/dialog.js'/>"></script>
<script type="text/javascript" src="<c:url value='/js/AJS.js'/>"></script>
<script type="text/javascript" src="<c:url value='/js/AJS_fx.js'/>"></script>
<script type="text/javascript">
	contextPath = "<%=request.getContextPath()%>";
	var user = "<%=request.getSession().getAttribute("user")%>";
	var old_ostype = "<%=request.getParameter("old_ostype")==null?0:request.getParameter("old_ostype")%>";
	var old_arch = "<%=request.getParameter("old_arch")==null?0:request.getParameter("old_arch")%>";
	var agentPageNum = "<%=request.getParameter("agentPageNum")==null?1:request.getParameter("agentPageNum")%>";
	var filePageNum = "<%=request.getParameter("filePageNum")==null?1:request.getParameter("filePageNum")%>";
	var old_status = "<%=request.getParameter("old_status")==null?"00":request.getParameter("old_status")%>";
	var StringPageSize = 20;
	//初始化生成列表
	$(document).ready(function(){
		if(user==null || user=="" || user=="null"){
			window.location.href = "../login.jsp";
			return;
		}
		showPublish();
		initagentsAndfils();
	});
	
	function initagentsAndfils(){
		$("#ostypeNew").val(old_ostype);
		$("#archNew").val(old_arch);
		$("#statusNew").val(old_status);
		var agentPageNum = $("#agent_pageNum").html();
		var filePageNum = $("#file_pageNum").html();
		$('#container-1 ul').tabs();
		 $('#container-2 ul').tabs();
		 var stringAgent = "<tr><th>名称</th><th>文件名称</th><th>下载地址</th><th>md5值</th><th>版本号</th><th>状态</th><th>是否开机启动</th><th>操作系统类型</th><th>操作系统位数</th><th>操作</th></tr>"
		 var stringFile = "<tr><th>文件名称</th><th>下载地址</th><th>状态</th><th>操作系统类型</th><th>操作系统位数</th><th>操作</th></tr>";
		$.ajax({
			type: "POST",
			url: contextPath  + "/look_agent_by_osarch.do",
			data:{ostype:old_ostype,arch:old_arch,status:old_status,StringPageNum:agentPageNum,StringPageSize:StringPageSize},
			success: function(p) {
				var agents = p.list;
			  	for(var i=0;i<agents.length;i++){
				  var agent = agents[i];
				  var status = agent.status;
				  var loadonstartup = agent.loadonstartup;
				  var downloaduri = agent.downloaduri;
				  if(loadonstartup=="1"){
					  loadonstartup = "是";
				  }
				  if(loadonstartup=="0"){
					  loadonstartup = "否";
				  }
				  if(status=="0"){
					  status = "release";
				  }
				  if(status=="1"){
					  status = "预发布";
				  }
				  if(status=="2"){
					  status = "发布";
				  }
				  var loaduri = downloaduri.replace("download","");
				  var downloaduris = downloaduri.split("/");
				  var easy_downloaduri = downloaduris[0]+"/"+downloaduris[1]+"/.../"+downloaduris[6];
				  if(i%2==0){
					  stringAgent += "<tr style='background-color:#ffffff'>"+
						"<td style='text-align:left;'>"+agent.name+"</td>"+
						"<td style='text-align:left;'>"+agent.filename+"</td>"+
						"<td style='text-align:left;' title='"+downloaduri+"'><span>"+easy_downloaduri+"</span><img src='../images/xiazai.png' width='12' height='12' style='margin:0px 1px; text-decoration: none;cursor:pointer; ' onclick="+"changeURL('"+loaduri+"')></td>" +
						"<td style='text-align:left;'>"+agent.md5sum+"</td>" +
						"<td>"+agent.version+"</td>"+ 
						"<td>"+status+"</td>"+
						"<td>"+loadonstartup+"</td>"+
						 "<td title='"+agent.ostype+"'>"+agent.ostype+"</td>"+
						 "<td>"+agent.arch+"</td>"+ 
						 "<td style='text-align:center;'><input type='button' class='Button' value='删除' onclick='deleteAgent("+agent.id+")'/><input type='button' class='Button' value='修改' onclick='open5("+agent.id+")'/><input type='button' class='Button' value='添加' onclick='addAgent("+agent.id+")'/></td>"+
						 "</tr>";
				  }else{
					  stringAgent += "<tr style='background-color:#eeeeee'>"+
						"<td style='text-align:left;'>"+agent.name+"</td>"+
						"<td style='text-align:left;'>"+agent.filename+"</td>"+
						"<td style='text-align:left;' title='"+downloaduri+"'><span>"+easy_downloaduri+"</span><img src='../images/xiazai.png' width='12' height='12' style='margin:0px 1px; text-decoration: none;cursor:pointer; ' onclick="+"changeURL('"+loaduri+"')></td>" +
						"<td style='text-align:left;'>"+agent.md5sum+"</td>" +
						"<td>"+agent.version+"</td>"+ 
						"<td>"+status+"</td>"+
						"<td>"+loadonstartup+"</td>"+
						 "<td>"+agent.ostype+"</td>"+
						 "<td>"+agent.arch+"</td>"+ 
						 "<td style='text-align:center;'><input type='button' class='Button' value='删除' onclick='deleteAgent("+agent.id+")'/><input type='button' class='Button' value='修改' onclick='open5("+agent.id+")'/><input type='button' class='Button' value='添加' onclick='addAgent("+agent.id+")'/></td>"+
						 "</tr>";
				  }
				  
			  }
			  //var pageTr = "<tr><td colspan='10'>共条"+p.totalNumber+"记录 共"+p.totalPage+"页 当前第页 首页 上一页 下一页 末页</td></tr>";
			  $("#agent_totalNumber").html(p.totalNumber);
			  $("#agent_totalPage").html(p.totalPage);
			  $("#agent_detail").html(stringAgent); 
			},
			dataType : "json"
		});	
		
		$.ajax({
			type: "POST",
			url: contextPath  + "/look_file_by_osarch.do",
			data:{ostype:old_ostype,arch:old_arch,status:old_status,StringPageNum:filePageNum,StringPageSize:StringPageSize},
			success: function(p) {
				var files = p.list;
			  for(var i=0;i<files.length;i++){
				  var file = files[i];
				  var status = file.status;
				  var downloaduri = file.downloaduri;
				  var loaduri = downloaduri.replace("download","");
				  if(status=="0"){
					  status = "release";
				  }else if(status=="1"){
					  status = "预发布";
				  }else if(status=="2"){
					  status = "发布";
				  }
				  var downloaduris = downloaduri.split("/");
				  var easy_downloaduri = downloaduris[0]+"/"+downloaduris[1]+"/.../"+downloaduris[6];
				  if(i%2==0){
					  stringFile += "<tr style='background-color:#ffffff'><td style='text-align:left;'>"+file.filename+"</td><td style='text-align:left;'><span>"+easy_downloaduri+"</span><img src='../images/xiazai.png' width='12' height='12' style='margin:0px 1px; text-decoration: none;cursor:pointer; ' onclick="+"changeURL('"+loaduri+"')></td><td>"+
						 status+"</td><td>"+file.ostype+"</td><td>"+file.arch+"</td><td><input type='button' class='Button' value='删除' onclick='deleteFile("+file.id+")'/><input type='button' class='Button' value='修改' onclick='open6("+file.id+")'/><input type='button' class='Button' value='添加' onclick='addFile("+file.id+")'/></td></tr>"
				  }else{
					  stringFile += "<tr style='background-color:#eeeeee'><td  style='text-align:left;'>"+file.filename+"</td><td  style='text-align:left;'><span>"+easy_downloaduri+"</span><img src='../images/xiazai.png' width='12' height='12' style='margin:0px 1px; text-decoration: none;cursor:pointer; ' onclick="+"changeURL('"+loaduri+"')></td><td>"+
						 status+"</td><td>"+file.ostype+"</td><td>"+file.arch+"</td><td><input type='button' class='Button' value='删除' onclick='deleteFile("+file.id+")'/><input type='button' class='Button' value='修改' onclick='open6("+file.id+")'/><input type='button' class='Button' value='添加' onclick='addFile("+file.id+")'/></td></tr>"
				  }
				 
			  }
			  $("#file_totalNumber").html(p.totalNumber);
			  $("#file_totalPage").html(p.totalPage);
			  $("#file_detail").html(stringFile);
			},
			dataType : "json"
		});
	}
	function showDownloadsDetail(downloaduri){
		//alert(downloaduri);
	}
	//更改操作系统类型和状态
	function changeArchOrosStatus(){
		var old_ostype = $("#ostypeNew").val();
		var old_arch = $("#archNew").val();
		var old_status = $("#statusNew").val();
		var agentPageNum = $("#agent_pageNum").html();
		var filePageNum = $("#file_pageNum").html();
		window.location.href = "agent_file_list.jsp?old_ostype="+old_ostype+"&old_arch="+old_arch+"&old_status="+old_status+"&agentPageNum="+agentPageNum+"&filePageNum="+filePageNum;
	}
	function changeURL(downloaduri){
		window.location.href = "../download"+downloaduri;
	}
	//添加到发布栏目
	function addAgent(id){
		$.ajax({
			type: "POST",
			url: contextPath  + "/add_agent_to_cookie.do",
			data:{id:id},
			success: function(obj) {
				  //showPublish();
				  if(obj==1){
					  alert("已经存在这个文件。");
				  }
				  //window.location.href = "agent_file_list.jsp";
				  changeArchOrosStatus();
			},
			dataType : "json"
		});	
	}
	
	//添加到发布栏目
	function addFile(id){
		$.ajax({
			type: "POST",
			url: contextPath  + "/add_file_to_cookie.do",
			data:{id:id},
			success: function(obj) {
				if(obj==1){
					  alert("已经存在这个文件。");
				  }
				  //window.location.href = "agent_file_list.jsp";
				changeArchOrosStatus();
			},
			dataType : "json"
		});	
	}
	
	//显示将要发布的信息
	function showPublish(){
		$.ajax({
			type: "POST",
			url: contextPath  + "/show_agent_in_cookie.do",
			success: function(agents) {
				if(agents[0].md5sum!="0"){
					$("#container-2").show();
					for(var i=agents.length-1;i >= 0;i--){
						  var agent = agents[i];
						  var loadonstartup = agent.loadonstartup;
						  if(loadonstartup=="1"){
							  loadonstartup = "是";
						  }
						  if(loadonstartup=="0"){
							  loadonstartup = "否";
						  }
						 $("#agent_cookie_detail").append("<tr>"+
								 					"<td>"+agent.name+"</td>"+
								 					"<td>"+agent.filename+"</td>"+
								 					"<td>"+agent.downloaduri+"</td>" +
								 					"<td>"+agent.md5sum+"</td>"+ 
								 					"<td>"+agent.version+"</td>"+ 
													 "<td>"+loadonstartup+"</td>"+
													 "<td>"+agent.ostype+"</td>"+
													 "<td>"+agent.arch+"</td>"+ 
													 "<td><input type='button' class='Button' value='删除' onclick='deleteAgentByCookie("+agent.id+")'/></td>"+
													 "</tr>");
					}
				}
				
				},
				dataType : "json"
		});	
		
		$.ajax({
			type: "POST",
			url: contextPath  + "/show_file_in_cookie.do",
			success: function(files) {
				if(files[0].md5sum!="0"){
					$("#container-2").show();
					for(var i=files.length-1;i >= 0;i--){
						  var file = files[i];
						 $("#file_cookie_detail").append("<tr>"+
								 					"<td>"+file.filename+"</td>"+
								 					"<td>"+file.downloaduri+"</td>" +
													 "<td>"+file.ostype+"</td>"+
													 "<td>"+file.arch+"</td>"+ 
													 "<td><input type='button' class='Button' value='删除' onclick='deleteFileByCookie("+file.id+")'/></td>"+
													 "</tr>");
					  }
				}
				
				},
				dataType : "json"
		});	
	}
	
	//删除对应的记录
	function deleteAgent(id){
		$.ajax({
			type: "POST",
			url: contextPath  + "/delete_agent.do",
			data:{id:id},
			success: function(obj) {
				  alert("删除成功。");
				  //initagentsAndfils();
				  changeArchOrosStatus();
			},
			dataType : "json"
		});	
	}
	
	//删除对应的记录
	function deleteFile(id){
		$.ajax({
			type: "POST",
			url: contextPath  + "/delete_file.do",
			data:{id:id},
			success: function(obj) {
				  alert("删除成功。");
				  //initagentsAndfils();
				  changeArchOrosStatus();
			},
			dataType : "json"
		});	
	}
	
	//从cookie中删除对应记录
	function deleteAgentByCookie(id){
		$.ajax({
			type: "POST",
			url: contextPath  + "/delete_agent_by_cookie.do",
			data:{id:id},
			success: function(obj) {
				  if(obj == "0"){
					  alert("删除失败。");
				  }
				  //window.location.href = "agent_file_list.jsp";
				  changeArchOrosStatus();
			},
			dataType : "json"
		});	
	}
	
	//从cookie中删除对应记录
	function deleteFileByCookie(id){
		$.ajax({
			type: "POST",
			url: contextPath  + "/delete_file_by_cookie.do",
			data:{id:id},
			success: function(obj) {
				  if(obj == "0"){
					  alert("删除失败。");
				  }
				  //window.location.href = "agent_file_list.jsp";
				  changeArchOrosStatus();
			},
			dataType : "json"
		});	
	}
	
	//上传
	function upload(){
		var value=document.getElementById("picpath").value;
		//var value = $("#selectFile").value;
		if(value.indexOf("\\") != -1){
			value = value.substring(value.lastIndexOf("\\")+1,value.lenght);
		}
	    if(value==""){
	       alert("请选择上传文件。");
	       return false;
	    }
	    var reg = /[\u4e00-\u9fa5]/;
	    if(reg.test(value)){
			alert("文件名不能是中文。");
			//emptyFile();//清空file
			return false;
		}
	    var ostype = $("#ostype").val();
		var arch = $("#arch").val();
		var filetype = $("#filetype").val();
		var version = $("#version2").val();
		var name = $("#name").val();
		var filename = $("#filename").val();
		var chuanStatus = $("#chuanStatus").val();
		if(chuanStatus==""){
			alert("请选择上传状态。");
			return false;
		}
		if(ostype==""){
			alert("请选择操作系统类型。");
			return false;
		}
		if(arch==""){
			alert("请选择操作系统位数。");
			return false;
		}
		if(filetype==""){
			alert("请选择文件类型。");
			return false;
		}
		if(filetype==2&&version==""){
			alert("请输入版本号。");
			return false;
		}
		if(filetype==2&&name==""){
			alert("请输入名称。");
			return false;
		}
		if(filename==""){
			alert("请输入文件名称。");
			return false;
		}
		var l = document.getElementsByName("isOnload");
		var loadonstartup = "";
		for(var i=0;i<l.length;i++){
			if(l[i].checked){
				loadonstartup = l[i].value;
			}
		}
		if(filetype==2&&loadonstartup==""){
			alert("请选择是否开机启动。");
			return false;
		}
		
	    $.ajaxFileUpload({
			url:contextPath+"/uploadFile.do",
			secureuri:false,
			fileElementId:'picpath',
			dataType: 'json',
			data:{"item":"ajax",filetype:filetype},
			success: function (data){
				if(data.msg=='0'){
					if(data.msg=="ObjectAlreadyExists"){
						uploadSucc("red");
						alert("上传失败，文件已存在。");
					}
				}else{
					filenameAndMd5 = data.msg;
					alert("上传成功。");
					createAgentOrFile(filenameAndMd5);
				}
			},
			error: function (data, status, e){
				if(XMLHttpRequest.status == 403 && errorThrown == "Forbidden") {
					window.location.reload();
				} else {
					console.log(textStatus.error + "" + errorThrown);
				}
			}
		});
	   
	}
	
	//上传后创建数据
	function createAgentOrFile(filenameAndMd5){
		var filenameAndMd5s = filenameAndMd5.split("_");
		var md5sum = filenameAndMd5s[0];
		var downloaduri = filenameAndMd5s[1];
		var haomiao = filenameAndMd5s[2];
		var name = $("#name").val();
		var filename = $("#filename").val();
		var ostype = $("#ostype").val();
		var arch = $("#arch").val();
		var filetype = $("#filetype").val();
		var version = $("#version2").val();
		var chuanStatus = $("#chuanStatus").val();
		var l = document.getElementsByName("isOnload");
		var loadonstartup = "";
		for(var i=0;i<l.length;i++){
			if(l[i].checked){
				loadonstartup = l[i].value;
			}
		}
		$.ajax({
			type: "POST",
			url: contextPath  + "/insert_agent_or_file.do",
			data:{filetype:filetype,version:version,md5sum:md5sum,name:name,filename:filename,arch:arch,ostype:ostype,downloaduri:downloaduri,loadonstartup:loadonstartup,haomiao:haomiao,chuanStatus:chuanStatus},
			success: function(obj) {
				location.reload();
			},
			dataType : "json"
		});
	}
	//清空文件
	function emptyFile(){  
		var file = $("#picpath");
		if(file.val()!=""){    //当file有地址才进行清空  
	      //var cfile=$(this).clone();  //复制当前file  
	      file.remove();     //移除当前file  
	      $("#picpath_div").append("<input type='file' name='picpath' id='picpath' />");  //把复制的file添加到目标td中
	   }
	}
	
	//打开上传信息
	function open4(){
		var content = '<form>'+
	'<table class="uploadTable">'+
	'	<tr>'+
	'		<th>文件类型：</th>'+
	'		<td>'+
	'			<select id="filetype" onchange="changeFileType()" class="fileType" data-label="文件类型">'+
	'			<option value="" selected="">  ---请点击选择---</option>'+
	'				<option value="2">   Agent</option>'+
	'				<option value="1">   File</option>'+
	'			</select>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>上传状态：</th>'+
	'		<td>'+
	'			<select id="chuanStatus" class="fileType" data-label="文件状态">'+
	'			<option value="" selected="">  ---请点击选择---</option>'+
	'				<option value="0">   release</option>'+
	'				<option value="1">   预发布</option>'+
	'			</select>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>名称：</th>'+
	'		<td>'+
	'			<input type="text" id="name" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>文件名称：</th>'+
	'		<td>'+
	'			<input type="text" id="filename" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>操作系统类型：</th>'+
	'		<td>'+
	'			<select id="ostype" class="osType" data-label="文件类型">'+
	'				<option value="" selected=""> ---请点击选择---</option>'+
	'				<option value="windows">windows</option>'+
	'				<option value="linux">linux</option>'+
	'				<option value="darwin">darwin</option>'+
	'			</select>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>操作系统位数：</th>'+
	'		<td>'+
	'			<select id="arch" class="osByte" data-label="文件类型">'+
	'				<option value="" selected="">         ---请点击选择---</option>'+
	'				<option value="32">32位</option>'+
	'				<option value="64">64位</option>'+
	'			</select>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>是否开机启动：</th>'+
	'		<td>'+
	'			<input type="radio" value="1" name="isOnload"/>是　　<input type="radio" value="0" name="isOnload"/>否'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>版本号：</th>'+
	'		<td>'+
	'			<input type="text" id="version2" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>文件选择：</th>'+
	'		<td>'+
	'			<input type="file" id="picpath" class="picpath" name="picpath"/>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<td colspan="2">'+
	'			<hr/>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<td colspan="2" align="center" class="btn">'+
	'			<input type="button" class="Button" onclick="dlg.hide()" value="确定"/> <input type="button" class="Button" onclick="dlg.close()" value="取消"/>'+
	'		</td>'+
	'	</tr>'+
	'</table>';
		dlg = new Dialog(content,{
			title:'文件上传',
			afterClosee:function(){
				//alert('after hide；调用后，显示页面内容');
				this.close();
			},
			beforeHide:function(){
				return upload();
			},
			modal:true
			});
		dlg.show();
	}
	
	//打开修改agent信息
	function open5(id){
		//alert($("#modify_filename").val());
		var content = '<form>'+
	'<table id="open5" class="uploadTable">'+
	'	<tr style="display:none;">'+
	'		<th>名称：</th>'+
	'		<td>'+
	'			<input type="text" id="modify_name" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>文件名称：</th>'+
	'		<td>'+
	'			<input type="text" id="modify_filename" value="" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>操作系统类型：</th>'+
	'		<td>'+
	'			<select id="modify_ostype" class="osType" data-label="文件类型">'+
	'				<option value="" selected=""> ---请点击选择---</option>'+
	'				<option value="windows">windows</option>'+
	'				<option value="linux">linux</option>'+
	'				<option value="darwin">darwin</option>'+
	'			</select>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>操作系统位数：</th>'+
	'		<td>'+
	'			<select id="modify_arch" class="osByte" data-label="文件类型">'+
	'				<option value="" selected="">         ---请点击选择---</option>'+
	'				<option value="32">32位</option>'+
	'				<option value="64">64位</option>'+
	'			</select>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>发布状态：</th>'+
	'		<td>'+
	'			<select id="modify_status" class="fileType" data-label="发布状态">'+
	'			<option value="" selected="">  ---请点击选择---</option>'+
	'				<option value="0">   release</option>'+
	'				<option value="1">   预发布</option>'+
	'				<option value="2">   发布</option>'+
	'			</select>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>是否开机启动：</th>'+
	'		<td>'+
	'			<input type="radio" value="1" name="modify_isOnload"/>是　　<input type="radio" value="0" name="modify_isOnload"/>否'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>版本号：</th>'+
	'		<td>'+
	'			<input type="text" id="modify_version2" value="" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr style="display:none;">'+
	'		<th>文件名称：</th>'+
	'		<td>'+
	'			<input type="text" id="modify_md5sum" value="" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr style="display:none;">'+
	'		<th>下载地址：</th>'+
	'		<td>'+
	'			<input type="text" id="modify_downloaduri" value="" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<td colspan="2">'+
	'			<hr/>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<td colspan="2" align="center" class="btn">'+
	'			<input type="button" class="Button" onclick="dlg.hide()" value="修改"/> <input type="button" class="Button" onclick="dlg.close()" value="取消"/>'+
	'		</td>'+
	'	</tr>'+
	'</table>';
		dlg = new Dialog(content,{
			title:'文件上传',
			afterClosee:function(){
				//alert('after hide；调用后，显示页面内容');
				this.close();
			},
			beforeHide:function(){
				return modifyAgent(id);
			},
			modal:true
			});
		dlg.show();
		
		$.ajax({
			type: "POST",
			url: contextPath  + "/get_agent_by_id.do",
			data:{id:id},
			success: function(obj) {
				//$("#ostype option[value='']").attr("selected",true);
				$("#modify_ostype option[value='"+ obj.ostype +"']").attr("selected",true);
				$("#modify_arch option[value='"+ obj.arch +"']").attr("selected",true);
				$("#modify_status option[value='"+ obj.status +"']").attr("selected",true);
				$("input[type='text'][id='modify_version2']").val(obj.version);
				$("input[type='text'][id='modify_filename']").val(obj.filename);
				
				$("input[type='text'][id='modify_name']").val(obj.name);
				$("input[type='text'][id='modify_downloaduri']").val(obj.downloaduri);
				$("input[type='text'][id='modify_md5sum']").val(obj.md5sum);
				$(":radio[name='modify_isOnload'][value='"+obj.loadonstartup+"']").attr("checked",true);
			},
			dataType : "json"
		});	
	}
	
	function modifyAgent(id){
		var name = $("#open5 input[type='text'][id='modify_name']").val();
		var ostype = $("#open5 #modify_ostype").val();
		var arch = $("#open5 #modify_arch").val();
		var version = $("#open5 input[type='text'][id='modify_version2']").val();
		var status = $("#open5 #modify_status").val();
		var filename = $("#open5 input[type='text'][id='modify_filename']").val();
		var downloaduri = $("#open5 #modify_downloaduri").val();
		var md5sum = $("#open5 #modify_md5sum").val();
		var l = document.getElementsByName("modify_isOnload");
		var loadonstartup = "";
		for(var i=0;i<l.length;i++){
			if(l[i].checked){
				loadonstartup = l[i].value;
			}
		}
		$("#open5").remove();
		if(ostype==""){
			alert("请选择操作系统类型。");
			return false;
		}
		if(arch==""){
			alert("请选择操作系统位数。");
			return false;
		}
		if(version==""){
			alert("请输入版本号。");
			return false;
		}
		if(status==""){
			alert("请选择发布状态。");
			return false;
		}
		if(filename==""){
			alert("请输入文件名称。");
			return false;
		}
		
		$.ajax({
			type: "POST",
			url: contextPath  + "/modify_agent.do",
			data:{name:name,ostype:ostype,arch:arch,id:id,status:status,version:version,filename:filename,downloaduri:downloaduri,md5sum:md5sum,loadonstartup:loadonstartup},
			success: function(ajaxResponse) {
				if(ajaxResponse.id!=""){
					changeArchOrosStatus();
					//initagentsAndfils();
					//window.location.reload()
				}
			},
			dataType : "json"
		});
		
		return true;
	}
	
	//打开修改file信息
	function open6(id){
		var content = '<form>'+
	'<table id="open5" class="uploadTable">'+
	'	<tr>'+
	'		<th>文件名称：</th>'+
	'		<td>'+
	'			<input type="text" id="modify_filename" value="" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>操作系统类型：</th>'+
	'		<td>'+
	'			<select id="modify_ostype" class="osType" data-label="文件类型">'+
	'				<option value="" selected=""> ---请点击选择---</option>'+
	'				<option value="windows">windows</option>'+
	'				<option value="linux">linux</option>'+
	'				<option value="darwin">darwin</option>'+
	'			</select>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>操作系统位数：</th>'+
	'		<td>'+
	'			<select id="modify_arch" class="osByte" data-label="文件类型">'+
	'				<option value="" selected="">         ---请点击选择---</option>'+
	'				<option value="32">32位</option>'+
	'				<option value="64">64位</option>'+
	'			</select>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<th>发布状态：</th>'+
	'		<td>'+
	'			<select id="modify_status" class="fileType" data-label="发布状态">'+
	'			<option value="" selected="">  ---请点击选择---</option>'+
	'				<option value="0">   release</option>'+
	'				<option value="1">   预发布</option>'+
	'				<option value="2">   发布</option>'+
	'			</select>'+
	'		</td>'+
	'	</tr>'+
	'	<tr style="display:none;">'+
	'		<th>md5：</th>'+
	'		<td>'+
	'			<input type="text" id="modify_md5sum" value="" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr style="display:none;">'+
	'		<th>下载地址：</th>'+
	'		<td>'+
	'			<input type="text" id="modify_downloaduri" value="" class="selectFile" />'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<td colspan="2">'+
	'			<hr/>'+
	'		</td>'+
	'	</tr>'+
	'	<tr>'+
	'		<td colspan="2" align="center" class="btn">'+
	'			<input type="button" class="Button" onclick="dlg.hide()" value="修改"/> <input type="button" class="Button" onclick="dlg.close()" value="取消"/>'+
	'		</td>'+
	'	</tr>'+
	'</table>';
		dlg = new Dialog(content,{
			title:'文件上传',
			afterClosee:function(){
				//alert('after hide；调用后，显示页面内容');
				this.close();
			},
			beforeHide:function(){
				return modifyFile(id);
			},
			modal:true
			});
		dlg.show();
		
		$.ajax({
			type: "POST",
			url: contextPath  + "/get_file_by_id.do",
			data:{id:id},
			success: function(obj) {
				//$("#ostype option[value='']").attr("selected",true);
				$("#modify_ostype option[value='"+ obj.ostype +"']").attr("selected",true);
				$("#modify_arch option[value='"+ obj.arch +"']").attr("selected",true);
				$("#modify_status option[value='"+ obj.status +"']").attr("selected",true);
				$("input[type='text'][id='modify_filename']").val(obj.filename);
				
				$("input[type='text'][id='modify_downloaduri']").val(obj.downloaduri);
				$("input[type='text'][id='modify_md5sum']").val(obj.md5sum);
			},
			dataType : "json"
		});	
		var content = '';
	}
	
	function modifyFile(id){
		var ostype = $("#open5 #modify_ostype").val();
		var arch = $("#open5 #modify_arch").val();
		var status = $("#open5 #modify_status").val();
		
		var filename = $("#open5 input[type='text'][id='modify_filename']").val();
		var downloaduri = $("#open5 #modify_downloaduri").val();
		var md5sum = $("#open5 #modify_md5sum").val();
		if(filename==""){
			alert("请输入文件名称。");
			return false;
		}
		if(ostype==""){
			alert("请选择操作系统类型。");
			return false;
		}
		if(arch==""){
			alert("请选择操作系统位数。");
			return false;
		}
		if(status==""){
			alert("请选择发布状态。");
			return false;
		}
		$("#open5").remove();
		$.ajax({
			type: "POST",
			url: contextPath  + "/modify_file.do",
			data:{ostype:ostype,arch:arch,id:id,status:status,filename:filename,downloaduri:downloaduri,md5sum:md5sum},
			success: function(ajaxResponse) {
				if(ajaxResponse.id!=""){
					changeArchOrosStatus();
					//initagentsAndfils();
					//window.location.reload()
				}
			},
			dataType : "json"
		});
		
		return true;
	}
	
	//预发布
	function preRelease(){
		var content = '<form>'+
		'<table class="uploadTable">'+
		'	<tr>'+
		'		<th>操作系统类型：</th>'+
		'		<td>'+
		'			<select id="osType" class="osType" data-label="文件类型">'+
		'				<option value="" selected=""> ---请点击选择---</option>'+
		'				<option value="windows">windows</option>'+
		'				<option value="linux">linux</option>'+
		'				<option value="darwin">darwin</option>'+
		'			</select>'+
		'		</td>'+
		'	</tr>'+
		'	<tr>'+
		'		<th>操作系统位数：</th>'+
		'		<td>'+
		'			<select id="arch" class="osByte" data-label="文件类型">'+
		'				<option value="" selected="">         ---请点击选择---</option>'+
		'				<option value="32">32位</option>'+
		'				<option value="64">64位</option>'+
		'			</select>'+
		'		</td>'+
		'	</tr>'+
		'	<tr>'+
		'		<td colspan="2" style="text-align: center;">'+
		'			<span style="color:red;font-size:12px;">需要发布的信息是预发布的信息，请把状态改成预发布。</span>'+
		'		</td>'+
		'	</tr>'+
		'	<tr>'+
		'		<td colspan="2">'+
		'			<hr/>'+
		'		</td>'+
		'	</tr>'+
		'	<tr>'+
		'		<td colspan="2" align="center" class="btn">'+
		'			<input type="button" class="Button" onclick="dlg.hide()" value="预发布"/> <input type="button" class="Button" onclick="dlg.close()" value="取消"/>'+
		'		</td>'+
		'	</tr>'+
		'</table>';
		dlg = new Dialog(content,{
			title:'预发布',
			afterClosee:function(){
				this.close();
			},
			beforeHide:function(){
				var ostype = $("#osType").val();
				var arch = $("#arch").val();
				if(ostype==""){
					alert("请选择操作系统类型。");
					return false;
				}
				if(arch==""){
					alert("请选择操作系统位数。");
					return false;
				}
				$.ajax({
					type: "POST",
					url: contextPath  + "/look_agent.do",
					data:{ostype:ostype,arch:arch},
					success: function(agents) {
							$.ajax({
								type: "POST",
								url: contextPath  + "/look_file.do",
								data:{ostype:ostype,arch:arch},
								success: function(files) {
									if(files[0].md5sum=="0"&&agents[0].md5sum=="0"){
										alert("没有发布的内容，请确认发布的信息。");
										//window.location.href = "agent_file_list.jsp";
										changeArchOrosStatus();
									}else{
										//window.location.href = "agent_file_list.jsp";
										changeArchOrosStatus();
										window.location.href = "preview.jsp?ostype="+ostype+"&arch="+arch+"&index=0";
										//window.open("preview.jsp?ostype="+ostype+"&arch="+arch+"&index=0");
									}
								},
								dataType : "json"
							});
					},
					dataType : "json"
				});
				return true;
			},
			modal:true
		});
		dlg.show();
	}
	
	//查看已经发布的信息
	function findPublished(){
		var content = '<form>'+
		'<table class="uploadTable">'+
		'	<tr>'+
		'		<th>操作系统类型：</th>'+
		'		<td>'+
		'			<select id="osType" class="osType" data-label="文件类型">'+
		'				<option value="" selected=""> ---请点击选择---</option>'+
		'				<option value="windows">windows</option>'+
		'				<option value="linux">linux</option>'+
		'				<option value="darwin">darwin</option>'+
		'			</select>'+
		'		</td>'+
		'	</tr>'+
		'	<tr>'+
		'		<th>操作系统位数：</th>'+
		'		<td>'+
		'			<select id="arch" class="osByte" data-label="文件类型">'+
		'				<option value="" selected="">         ---请点击选择---</option>'+
		'				<option value="32">32位</option>'+
		'				<option value="64">64位</option>'+
		'			</select>'+
		'		</td>'+
		'	</tr>'+
		'	<tr>'+
		'		<td colspan="2" style="text-align: center;">'+
		'			<span style="color:red;font-size:12px;">按照操作系统类型查询状态为已经发布的信息。</span>'+
		'		</td>'+
		'	</tr>'+
		'	<tr>'+
		'		<td colspan="2">'+
		'			<hr/>'+
		'		</td>'+
		'	</tr>'+
		'	<tr>'+
		'		<td colspan="2" align="center" class="btn">'+
		'			<input type="button" class="Button" onclick="dlg.hide()" value="确认"/> <input type="button" class="Button" onclick="dlg.close()" value="取消"/>'+
		'		</td>'+
		'	</tr>'+
		'</table>';
		dlg = new Dialog(content,{
			title:'查看已发布信息',
			afterClosee:function(){
				this.close();
			},
			beforeHide:function(){
				var ostype = $("#osType").val();
				var arch = $("#arch").val();
				if(ostype==""){
					alert("请选择操作系统类型。");
					return false;
				}
				if(arch==""){
					alert("请选择操作系统位数。");
					return false;
				}
				$.post(contextPath  + "/look_agent_by_status.do?ostype=" + ostype+
						   "&arch="+arch, function(data) {
					 if(data != ""){
						 window.location.href = "preview.jsp?ostype="+ostype+"&arch="+arch+"&index=2";
					 }else{
						 alert("没有已经发布的信息，请先发布。");
					 }
					});
				
				return true;
			},
			modal:true
		});
		dlg.show();
	}
	
	//根据cookie预发布
	function prereleaseBycookie(){
		var content = '<form>'+
						'<table class="uploadTable">'+
						'	<tr>'+
						'		<th>操作系统类型：</th>'+
						'		<td>'+
						'			<select id="osType" class="osType" data-label="文件类型">'+
						'				<option value="" selected=""> ---请点击选择---</option>'+
						'				<option value="windows">windows</option>'+
						'				<option value="linux">linux</option>'+
						'				<option value="darwin">darwin</option>'+
						'			</select>'+
						'		</td>'+
						'	</tr>'+
						'	<tr>'+
						'		<th>操作系统位数：</th>'+
						'		<td>'+
						'			<select id="osByte" class="osByte" data-label="文件类型">'+
						'				<option value="" selected="">         ---请点击选择---</option>'+
						'				<option value="32">32位</option>'+
						'				<option value="64">64位</option>'+
						'			</select>'+
						'		</td>'+
						'	</tr>'+
						'	<tr>'+
						'		<td colspan="2">'+
						'			<hr/>'+
						'		</td>'+
						'	</tr>'+
						'	<tr>'+
						'		<td colspan="2" align="center" class="btn">'+
						'			<input type="button" class="Button" onclick="dlg.hide()" value="预发布"/> <input type="button" class="Button" onclick="dlg.close()" value="取消"/>'+
						'		</td>'+
						'	</tr>'+
						'</table>';
		dlg = new Dialog(content,{
			title:'发布',
			afterClosee:function(){
				this.close();
			},
			beforeHide:function(){
				var ostype = $("#osType").val();
				var arch = $("#osByte").val();
				if(ostype==""){
					alert("请选择操作系统类型。");
					return false;
				}
				if(arch==""){
					alert("请选择操作系统位数。");
					return false;
				}
				window.location.href = "preview.jsp?ostype="+ostype+"&arch="+arch+"&index=1";
				//window.open("preview.jsp?ostype="+ostype+"&arch="+arch+"&index=1");
				return true;
			},
			modal:true
			});
		dlg.show();
	}
	
	function changeFileType(){
		var filetype = $("#filetype").val();
		if(filetype == '1'){
			$("form table.uploadTable tr:eq(2)").hide();
			$("form table.uploadTable tr:eq(6)").hide();
			$("form table.uploadTable tr:eq(7)").hide();
		}else{
			$("form table.uploadTable tr:eq(2)").show();
			$("form table.uploadTable tr:eq(6)").show();
			$("form table.uploadTable tr:eq(7)").show();
		}
	}

	
</script>

</head>
<body>
<div style="margin:10px;">
        <div id="btnDiv" style="padding:10px;">
			<input type="button" class="Button" onclick="open4()" value="上传"/>
			<!-- <input type="button" class="Button" onclick="release()" value="发布"/> -->
			<input type="button" class="Button" onclick="preRelease()" value="预发布"/>
			<input type="button" class="Button" onclick="findPublished()" value="查看已发布"/>
			<span>操作系统类型：<select id="ostypeNew" onchange="changeArchOrosStatus()">
					<option value="0">--请选择--</option>
					<option value="windows">windows</option>
					<option value="linux">linux</option>
					<option value="darwin">darwin</option>
				</select></span>
			<span>操作系统位数：<select id="archNew" onchange="changeArchOrosStatus()">
					<option value="0">--请选择--</option>
					<option value="32">32位</option>
					<option value="64">64位</option>
				</select></span>
			<span>发布状态：<select id="statusNew" onchange="changeArchOrosStatus()">
					<option value="00">--请选择--</option>
					<option value="0">release</option>
					<option value="1">预发布</option>
					<option value="2">发布</option>
				</select></span>
		</div>
        <input type="hidden" id="agentFileId" />
        <div id="container-1">
            <ul>
                <li style="margin: 0 0 0 12px;"><a href="#fragment-1"><span>Agent</span></a></li>
                <li><a href="#fragment-2"><span>File</span></a></li>
                <li><span style="color:red;text-font:12px;">如果发布特定的文件，请点击添加按钮进行发布。</span></li>
            </ul>
            <div id="fragment-1">
                <table id="agent_detail" class="agent_detail" cellspacing="0" cellpadding="0" width="100%" border="0">
                <!-- 
					<tr>
						<th>名称</th><th>文件名称</th><th>下载地址</th><th>md5值</th><th>版本号</th><th>状态</th><th>是否开机启动</th><th>操作系统类型</th><th>操作系统位数</th><th>操作</th>
					</tr>
				 -->
				</table>
				 <table class="agent_detail" cellspacing="0" cellpadding="0" width="100%" border="0">
				 	<tr><td colspan="10"><span>共条<span id="agent_totalNumber"></span>记录 共<span id="agent_totalPage"></span>页 当前第<span id="agent_pageNum">1</span>页 <span id="agent_first" style="text-decoration: none;cursor:pointer;" onclick="agentfirst()">首页</span>
				 	 <span id="agent_pre" style="text-decoration: none;cursor:pointer;" onclick="agentPre()">上一页</span> <span id="agent_next" style="text-decoration: none;cursor:pointer;" onclick="agentNext()">下一页</span> <span id="agent_last" style="text-decoration: none;cursor:pointer;" onclick="agentlast()">末页</span></span></td></tr>
				 </table>
            </div>
            <div id="fragment-2">
                <table  id="file_detail" class="file_detail" cellspacing="1" cellpadding="0" width="100%" border="1">
                <!-- 
					<tr>
						<th>文件名称</th><th>下载地址</th><th>状态</th><th>操作系统类型</th><th>操作系统位数</th><th>操作</th>
					</tr>
				 -->
				</table>
				<table class="file_detail" cellspacing="0" cellpadding="0" width="100%" border="0">
				 	<tr><td colspan="10"><span>共条<span id="file_totalNumber"></span>记录 共<span id="file_totalPage"></span>页 当前第<span id="file_pageNum">1</span>页 <span id="file_first" style="text-decoration: none;cursor:pointer;" onclick="filefirst()">首页</span>
				 	 <span id="file_pre" style="text-decoration: none;cursor:pointer;" onclick="filePre()">上一页</span> <span id="file_next" style="text-decoration: none;cursor:pointer;" onclick="fileNext()">下一页</span> <span id="file_last" style="text-decoration: none;cursor:pointer;" onclick="filelast()">末页</span></span></td></tr>
				 </table>
            </div>
          </div>
            
            <div id="container-2" style="display:none;margin-top:50px;">
            <ul>
                <li style="margin: 0 0 0 12px;"><a href="#fragment-3"><span>Agent</span></a></li>
                <li><a href="#fragment-4"><span>File</span></a></li>
                <li style="float:right"><span><input type="button" class="Button" onclick="prereleaseBycookie()" value="预发布"/></span></li>
            </ul>
            <div id="fragment-3">
                <table  id="agent_cookie_detail" class="agent_detail" cellspacing="0" cellpadding="0" width="100%" border="0">
					<tr>
						<th>名称</th><th>文件名称</th><th>下载地址</th><th>md5值</th><th>版本号</th><th>是否开机启动</th><th>操作系统类型</th><th>操作系统位数</th><th>操作</th>
					</tr>
				</table>
            </div>
            <div id="fragment-4">
                <table  id="file_cookie_detail" class="file_detail" cellspacing="1" cellpadding="0" width="100%" border="1">
					<tr>
						<th>文件名称</th><th>下载地址</th><th>操作系统类型</th><th>操作系统位数</th><th>操作</th>
					</tr>
				</table>
            </div>
            
        </div>
</div>
</body>
</html>
